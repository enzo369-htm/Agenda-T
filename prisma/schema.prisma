// Esquema de Prisma para Agenda Turnos Pro

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  PLATFORM_ADMIN
  BUSINESS_OWNER
  EMPLOYEE
  CLIENT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  MERCADOPAGO
  CASH
  OTHER
}

enum PlanType {
  FREE
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

// Modelos principales

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  phone         String?
  passwordHash  String?
  role          UserRole  @default(CLIENT)
  timezone      String    @default("America/Argentina/Buenos_Aires")
  locale        String    @default("es_AR")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  accounts      Account[]
  sessions      Session[]
  businesses    Business[]
  bookings      Booking[]
  reviews       Review[]
  notifications Notification[]
  employees     Employee[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Business {
  id          String   @id @default(cuid())
  ownerId     String
  name        String
  slug        String   @unique
  description String?  @db.Text
  category    String   @default("beauty")
  address     String
  city        String
  state       String
  country     String   @default("Argentina")
  postalCode  String?
  latitude    Float?
  longitude   Float?
  phone       String
  email       String?
  website     String?
  logo        String?
  coverImage  String?
  timezone    String   @default("America/Argentina/Buenos_Aires")
  isActive    Boolean  @default(true)
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Configuración de negocio (JSON)
  settings Json? // { bookingWindow, cancellationPolicy, requiresPayment, autoConfirm, etc. }

  // Horarios de apertura (JSON por día de semana)
  openingHours Json? // { monday: [{start: "09:00", end: "18:00"}], ... }

  // Relaciones
  owner         User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  services      Service[]
  employees     Employee[]
  bookings      Booking[]
  reviews       Review[]
  availability  Availability[]
  subscription  Subscription?
  payments      Payment[]
  notifications Notification[]

  @@index([slug])
  @@index([ownerId])
  @@index([category])
  @@index([isActive])
  @@map("businesses")
}

model Service {
  id               String   @id @default(cuid())
  businessId       String
  name             String
  description      String?  @db.Text
  durationMinutes  Int
  price            Float
  currency         String   @default("ARS")
  isActive         Boolean  @default(true)
  requiresEmployee Boolean  @default(true)
  color            String?  @default("#0ea5e9")
  image            String?
  order            Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relaciones
  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings Booking[]

  // Servicios que pueden ser ofrecidos por empleados
  employeeServices EmployeeService[]

  @@index([businessId])
  @@index([isActive])
  @@map("services")
}

model Employee {
  id         String   @id @default(cuid())
  businessId String
  userId     String?
  name       String
  email      String?
  phone      String?
  avatar     String?
  color      String?  @default("#9333ea")
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Horarios específicos del empleado (JSON)
  workingHours Json? // { monday: [{start: "09:00", end: "18:00"}], ... }

  // Relaciones
  business         Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  bookings         Booking[]
  availability     Availability[]
  employeeServices EmployeeService[]

  @@index([businessId])
  @@index([userId])
  @@index([isActive])
  @@map("employees")
}

// Tabla intermedia para servicios que puede ofrecer cada empleado
model EmployeeService {
  id         String   @id @default(cuid())
  employeeId String
  serviceId  String
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([employeeId, serviceId])
  @@index([employeeId])
  @@index([serviceId])
  @@map("employee_services")
}

model Availability {
  id         String   @id @default(cuid())
  businessId String
  employeeId String?
  date       DateTime @db.Date
  startTime  String // "09:00"
  endTime    String // "18:00"
  isBlocked  Boolean  @default(false)
  reason     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([businessId, date])
  @@index([employeeId, date])
  @@map("availability")
}

model Booking {
  id              String        @id @default(cuid())
  businessId      String
  serviceId       String
  employeeId      String?
  userId          String?
  clientName      String
  clientEmail     String
  clientPhone     String
  startTime       DateTime
  endTime         DateTime
  notes           String?       @db.Text
  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  requiresPayment Boolean       @default(false)
  totalPrice      Float
  currency        String        @default("ARS")
  reminderSent    Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relaciones
  business      Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service       Service        @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  employee      Employee?      @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  user          User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  payments      Payment[]
  notifications Notification[]
  review        Review?

  @@index([businessId])
  @@index([serviceId])
  @@index([employeeId])
  @@index([userId])
  @@index([startTime])
  @@index([status])
  @@map("bookings")
}

model Payment {
  id               String          @id @default(cuid())
  bookingId        String?
  businessId       String
  amount           Float
  currency         String          @default("ARS")
  provider         PaymentProvider @default(STRIPE)
  providerPaymentId String?       @unique
  status           PaymentStatus   @default(PENDING)
  metadata         Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([businessId])
  @@index([status])
  @@index([providerPaymentId])
  @@map("payments")
}

model Subscription {
  id                   String             @id @default(cuid())
  businessId           String             @unique
  planType             PlanType           @default(FREE)
  status               SubscriptionStatus @default(TRIAL)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@map("subscriptions")
}

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  businessId String
  userId     String
  rating     Int // 1-5
  comment    String?  @db.Text
  response   String?  @db.Text
  isVisible  Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

model Notification {
  id         String             @id @default(cuid())
  userId     String?
  businessId String?
  bookingId  String?
  channel    NotificationChannel
  recipient  String // email or phone number
  subject    String?
  message    String             @db.Text
  status     NotificationStatus @default(PENDING)
  sentAt     DateTime?
  deliveredAt DateTime?
  errorMessage String?          @db.Text
  metadata   Json?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([businessId])
  @@index([bookingId])
  @@index([status])
  @@map("notifications")
}

// Modelo para tracking de analytics y logs
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

